# event-driven-summarizer

## 目的

Summarizer のトリガーを固定間隔タイマー（`setInterval`）からイベント駆動に変更する。

現状の問題:
- 固定間隔でフラッシュするため、何も起きていなくてもタイマーが回り続ける
- 「入力待ちです」通知の前にサマリーが流れないため、文脈なしにいきなり通知が来る

ゴール:
- **何もしていない時**: 音声案内が流れない
- **動いている間**: 状況が更新されるたびに実況する
- **入力待ち・確認待ちの前**: まずサマリーを読み上げてから通知を流す

## 実装方針

### コアコンセプト: イベント駆動 + ターン完了前フラッシュ

固定間隔タイマーを廃止し、以下のトリガーでサマリーを生成する:

1. **turn_complete 検知時**: 蓄積イベントを即座にフラッシュ → サマリー読み上げ → 「入力待ちです」
2. **AskUserQuestion 検知時**: 蓄積イベントを即座にフラッシュ → サマリー読み上げ → 「確認待ち: {質問}」
3. **text イベント蓄積時**: `intervalMs` のスロットルタイマーでフラッシュ（長時間のターン中にも実況）

### フロー

```
Claude のターン開始
  ├── tool_use イベント → 蓄積（トリガーしない）
  ├── text イベント → 蓄積 + スロットルタイマー開始
  │   └── intervalMs 経過 → フラッシュ（長いターン中の中間実況）
  ├── AskUserQuestion → フラッシュ → サマリー → 「確認待ち: ...」
  └── turn_complete → フラッシュ → サマリー → 「入力待ちです」
```

## 完了条件

- [x] Summarizer が `setInterval` ではなくイベント駆動で動作する
- [x] turn_complete の前にサマリーがフラッシュされる
- [x] AskUserQuestion の前にサマリーがフラッシュされる
- [x] text イベント蓄積時にスロットルタイマーで中間実況される
- [x] イベントが無い期間は Ollama API コールが発生しない
- [x] 既存テストが全て通る
- [x] 新しいトリガー方式のテストを追加
- [x] `npm run build` / `npm run lint` / `npm test` が通る

## 作業ログ

- Summarizer: `setInterval` を廃止、`record(event, trigger?)` でスロットルタイマーを管理
  - `start()` は `active` フラグを立てるのみ
  - `flush()` はスロットルタイマーをキャンセルしてから実行
- Daemon: `handleTurnComplete()` と新設 `handleAskUserQuestion()` でサマリーフラッシュ後に通知
  - summarizer がない場合は従来通り同期的に動作
- テスト: summarizer のイベント駆動テスト 7 件、daemon のサマリー統合テスト 4 件を追加
