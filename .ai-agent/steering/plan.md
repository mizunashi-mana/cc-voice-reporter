# 実装計画

## 現在のフェーズ

フェーズ 3（堅牢化）まで完了。動作確認後の改善・バグ修正を経て、フェーズ 4（機能拡充）およびフェーズ 5（公開準備）に着手中。定期要約通知を実装済み。narration モードと翻訳機能は削除し、サマリモードのみの構成に簡素化。monorepo 化（npm workspaces）完了後、cli パッケージを cc-voice-reporter パッケージに統合し単一パッケージ構成に移行。音声出力コマンドのカスタマイズ機能を追加済み。サブコマンド体系（monitor, config, tracking）を導入済み。

## 方針変更の経緯

フェーズ 1 ではフック機構を利用してツール実行・通知イベントを音声報告していたが、Claude のテキスト応答（方針説明、結果報告など）はフックでは取得できなかった。`~/.claude/projects/` 配下の transcript .jsonl ファイルを監視することで、Claude の全出力を読み上げ可能になる。詳細は `.ai-agent/surveys/20260215-transcript-jsonl-watcher/README.md` を参照。

## フェーズ 1: フックベース MVP（完了）

- [x] devenv による開発環境セットアップ
- [x] プロジェクト初期セットアップ（TypeScript、npm、ESLint、Vitest、CI）
- [x] フックイベントの JSON パース処理
- [x] イベント種別ごとのメッセージ生成ロジック
- [x] macOS say コマンドの呼び出し処理
- [x] 全基本フックイベントの本格対応

## フェーズ 2: transcript .jsonl 監視方式への移行

### コアインフラ

- [x] chokidar v5 によるファイル監視の実装
  - [x] アクティブセッション .jsonl の検出（更新時刻ベース）
  - [x] 新規セッション開始時の自動切り替え
  - [x] サブエージェント .jsonl の監視
- [x] JSONL パーサー（行分割 + JSON.parse）
- [x] ファイルポジション追跡（tail ロジック）
- [x] 常駐デーモンとしての起動・停止

### メッセージ生成

- [x] Claude テキスト応答の読み上げ
  - [x] `type === "assistant"` + `content.type === "text"` の抽出
  - [x] 初期ブロック（`"\n\n"` のみ）の除外
  - [x] 同一 `requestId` のデバウンス処理
- [x] ツール実行情報の読み上げ（`content.type === "tool_use"` から）
- [x] フィルタリング（thinking, tool_result, progress は除外）

### 音声出力

- [x] say コマンドのキュー管理（排他制御）
- [x] 長文テキストの切り詰め処理

### 既存コードの整理

- [x] フック方式のコードを .jsonl 監視方式に置き換え
- [x] フック設定の削除
- [x] テストの書き直し

## フェーズ 3: 堅牢化

- [x] transcript JSONL スキーマのバリデーション（zod）
- [x] Claude Code バージョンアップ時のフォーマット変更への防御的パース
- [x] エラーハンドリングの強化
- [x] テストの充実

**動作確認**: フェーズ 3 完了後、実際の Claude Code セッションで動作テストを行う

## 動作確認後の改善・バグ修正

- [x] 長文テキストの省略方式を中間省略に変更（Issue #16）
- [x] プロジェクト切り替え時の音声案内とキュー優先制御（Issue #17）
- [x] AskUserQuestion の質問内容を音声再生（Issue #18）
- [x] プロジェクト切り替え案内が発生しないバグの修正（Issue #21）
- [x] タスク完了後のプロンプト待ち通知（Issue #25）
- [x] セッション単位のキュー優先制御（Issue #29）
- [x] 監視対象プロジェクトのフィルタリング（Issue #30）
- [x] Ollama を使った翻訳機能（Issue #35）
- [x] Logger 導入（Issue #41）
- [x] 翻訳の並行実行パイプライン（Issue #42）
- [x] graceful shutdown と強制シャットダウン（Issue #45）

## フェーズ 4: 機能拡充

- [x] Ollama ベースの定期要約通知（Issue #27, PR #49）
- [x] narration モード・翻訳機能の削除、サマリモードのみに簡素化（Issue #68）
- [x] 確認待ちメッセージの順序改善（Issue #34）
- [x] デフォルトでテキスト中略を無効化（Issue #37）
- [x] 入力済み時の「入力待ちです」抑制（Issue #38）
- [x] 多言語対応（日本語・英語）（Issue #24）
- [x] ESLint ルール強化と npm workspace による multi-package 化（Issue #53）
- [ ] ドキュメント整備

## 未分類の課題

- [ ] パーミッション確認プロンプトの読み上げ（Issue #23）
- [x] ~~プロジェクト切り替え時の案内が発話されないバグ（Issue #78）~~ — 再現せず、解決済みとしたが #103 で再発報告あり
- [ ] プロジェクト切り替え案内が発話されないことがある（再発）＋デバッグ情報の改善（Issue #103）
- [ ] 確認待ちの音声案内が回答後に遅れて再生され混乱する（Issue #104）
- [x] 音声言語をシステムロケールから自動検出する（Issue #76）
- [x] eslint-config-love と picstash の厳格な ESLint ルールを追加導入する（Issue #72）
- [x] `say` コマンドが使えない環境で `espeak-ng` へ自動フォールバック（Issue #83）
- [x] `config init` コマンドを対話式にし、スタートアップガイドを提供する（Issue #82）
- [x] Logger を DI に統一（Issue #47）
- [x] watcher テストのフレーキー修正（Issue #48）
- [x] ~~gemma3 モデルでの翻訳アボート問題（Issue #50）~~ — 翻訳機能削除により obsolete

## フェーズ 5: 公開準備

- [x] 音声出力コマンドのカスタマイズ（速度、声種など）（Issue #55）
- [x] CLI パッケージ追加・サブコマンド体系への再編（Issue #67）
- [x] npm パッケージとしての公開準備（Issue #98）
- [ ] `--version` / `--help` コマンドオプションの追加（Issue #101）
