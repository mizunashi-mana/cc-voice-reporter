# 実装計画

## 現在のフェーズ

フェーズ 2（transcript .jsonl 監視方式への移行）が完了。フェーズ 3 で堅牢化を行い、動作確認を経てフェーズ 4 以降で機能拡充に進む。

## 方針変更の経緯

フェーズ 1 ではフック機構を利用してツール実行・通知イベントを音声報告していたが、Claude のテキスト応答（方針説明、結果報告など）はフックでは取得できなかった。`~/.claude/projects/` 配下の transcript .jsonl ファイルを監視することで、Claude の全出力を読み上げ可能になる。詳細は `.ai-agent/surveys/20260215-transcript-jsonl-watcher/README.md` を参照。

## フェーズ 1: フックベース MVP（完了）

- [x] devenv による開発環境セットアップ
- [x] プロジェクト初期セットアップ（TypeScript、npm、ESLint、Vitest、CI）
- [x] フックイベントの JSON パース処理
- [x] イベント種別ごとのメッセージ生成ロジック
- [x] macOS say コマンドの呼び出し処理
- [x] 全基本フックイベントの本格対応

## フェーズ 2: transcript .jsonl 監視方式への移行

### コアインフラ

- [x] chokidar v5 によるファイル監視の実装
  - [x] アクティブセッション .jsonl の検出（更新時刻ベース）
  - [x] 新規セッション開始時の自動切り替え
  - [x] サブエージェント .jsonl の監視
- [x] JSONL パーサー（行分割 + JSON.parse）
- [x] ファイルポジション追跡（tail ロジック）
- [x] 常駐デーモンとしての起動・停止

### メッセージ生成

- [x] Claude テキスト応答の読み上げ
  - [x] `type === "assistant"` + `content.type === "text"` の抽出
  - [x] 初期ブロック（`"\n\n"` のみ）の除外
  - [x] 同一 `requestId` のデバウンス処理
- [x] ツール実行情報の読み上げ（`content.type === "tool_use"` から）
- [x] フィルタリング（thinking, tool_result, progress は除外）

### 音声出力

- [x] say コマンドのキュー管理（排他制御）
- [x] 長文テキストの切り詰め処理

### 既存コードの整理

- [x] フック方式のコードを .jsonl 監視方式に置き換え
- [x] フック設定の削除
- [x] テストの書き直し

## フェーズ 3: 堅牢化

- [ ] transcript JSONL スキーマのバリデーション（zod）
- [ ] Claude Code バージョンアップ時のフォーマット変更への防御的パース
- [ ] エラーハンドリングの強化
- [ ] テストの充実

**動作確認**: フェーズ 3 完了後、実際の Claude Code セッションで動作テストを行う

## フェーズ 4: 機能拡充

- [ ] メッセージのカスタマイズ機能（読み上げ対象の選択など）
- [ ] 多言語対応（日本語・英語）
  - [ ] メッセージ文字列をロケールファイルに分離
  - [ ] 環境変数 or 設定ファイルによる言語切り替え
  - [ ] say コマンドの音声（`-v` オプション）を言語に応じて切り替え
- [ ] ドキュメント整備

## フェーズ 5: 公開準備

- [ ] 音声の設定（速度、声種など）
- [ ] npm パッケージとしての公開準備
